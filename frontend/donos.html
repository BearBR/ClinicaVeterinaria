<!doctype html>
<html lang="pt-br">

<head>
    <meta charset="utf-8" />
    <title>Gerenciamento de Donos - Clínica Veterinária Unimar</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>

<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
        <div class="container-fluid">
            <a class="btn btn-outline-light me-2" href="/">← Voltar</a>
            <a class="navbar-brand" href="/">🐾 Clínica Veterinária Unimar</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/donos">Donos</a></li>
                    <li class="nav-item"><a class="nav-link" href="/pets">Pets</a></li>
                    <li class="nav-item"><a class="nav-link" href="/veterinarios">Veterinários</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container">
        <h1 class="h3 mb-3">Gerenciamento de Donos</h1>

        <form id="form-dono" class="card border-0 shadow-sm mb-4" novalidate>
            <div class="card-header bg-primary text-white">
                <h2 class="h5 mb-0">Cadastro de Dono</h2>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Nome Completo</label>
                        <input class="form-control" name="nome" placeholder="Nome" required maxlength="200" />
                        <div class="invalid-feedback">Nome é obrigatório (máx 200 caracteres).</div>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Telefone</label>
                        <input class="form-control" name="telefone" placeholder="(99) 99999-9999" inputmode="tel" maxlength="16" />
                        <div class="invalid-feedback">Telefone inválido. Use 10 ou 11 dígitos.</div>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" name="email" placeholder="email@exemplo.com" maxlength="254" />
                        <div class="invalid-feedback">Email inválido.</div>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">CEP</label>
                        <input class="form-control" name="cep" placeholder="CEP" inputmode="numeric" maxlength="9" />
                        <div class="invalid-feedback">CEP inválido. Deve conter 8 dígitos.</div>
                    </div>

                    <div class="col-12">
                        <label class="form-label">Endereço</label>
                        <input class="form-control" name="endereco" placeholder="Endereço" maxlength="300" />
                    </div>

                    <div class="col-12 d-grid gap-2">
                        <button class="btn btn-primary text-white" type="submit" id="submit-btn">
                            Salvar
                        </button>
                        <button class="btn btn-secondary" type="button" id="cancel-btn" style="display:none;" onclick="cancelarEdicao()">
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>
        </form>

        <table class="table table-sm table-striped mt-4">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nome & Email</th>
                    <th>Telefone</th>
                    <th>Endereço</th>
                    <th>CEP</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody id="tbody-donos"></tbody>
        </table>
    </main>

    <script>
        // API do backend
        const API = 'http://127.0.0.1:5000';
        let editandoId = null;

        // auth check
        fetch('/api/me').then(r => {
            if (!r.ok) window.location.href = '/login.html';
        });

        // formata CEP para exibição (99999-999)
        function formatCep(cep) {
            if (!cep && cep !== 0) return '';
            const s = String(cep).replace(/\D/g, '');
            if (s.length === 8) return s.slice(0, 5) + '-' + s.slice(5);
            return cep;
        }

        // funcao pra carregar donos
        async function carregarDonos() {
            const r = await fetch(`${API}/api/donos`);
            const dados = await r.json();

            let html = '';
            for (let i = 0; i < dados.length; i++) {
                let d = dados[i];
                html += `
                    <tr data-id="${d.id}">
                        <td>${d.id}</td>
                        <td>
                            <strong>${d.nome}</strong><br />
                            <span class="text-muted">${d.email || ''}</span>
                        </td>
                        <td>${d.telefone || ''}</td>
                        <td>${d.endereco || ''}</td>
                            <td>${formatCep(d.cep)}</td>
                        <td>
                            <button class="btn btn-danger btn-sm me-1" onclick="deletarDono(${d.id})">Excluir</button>
                            <button class="btn btn-warning btn-sm" onclick="editarDono(${d.id})">Editar</button>
                        </td>
                    </tr>
                `;
            }
            document.getElementById('tbody-donos').innerHTML = html;
        }

        // deleta um dono
        window.deletarDono = async function (id) {
            if (!confirm('Tem certeza?')) return;

            fetch(`${API}/api/donos/${id}`, { method: 'DELETE' })
                .then(response => {
                    if (!response.ok) {
                        alert('Erro ao deletar');
                        return;
                    }
                    alert('Deletado!');
                    carregarDonos();
                });
        };

        window.editarDono = async function (id) {
            const r = await fetch(`${API}/api/donos/${id}`);
            const dono = await r.json();

            // preenche o form
            document.querySelector('input[name=nome]').value = dono.nome || '';

            const telInput = document.querySelector('input[name=telefone]');
            telInput.value = dono.telefone || '';
            if (telInput && telInput.inputmask && dono.telefone) {
                try { telInput.inputmask.setValue(dono.telefone); } catch (e) { /* ignore */ }
            }

            document.querySelector('input[name=email]').value = dono.email || '';
            document.querySelector('input[name=endereco]').value = dono.endereco || '';

            const cepInput = document.querySelector('input[name=cep]');
            cepInput.value = dono.cep || '';
            if (cepInput && cepInput.inputmask && dono.cep) {
                try { cepInput.inputmask.setValue(dono.cep); } catch (e) { /* ignore */ }
            }

            editandoId = id;
            document.getElementById('submit-btn').textContent = 'Alterar';
            document.getElementById('cancel-btn').style.display = 'block';
        };

        window.cancelarEdicao = function () {
            editandoId = null;
            document.getElementById('form-dono').reset();
            document.getElementById('submit-btn').textContent = 'Salvar';
            document.getElementById('cancel-btn').style.display = 'none';
        };

        // submit do formulario
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('form-dono');

            function clearValidation() {
                form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            }

            function setInvalid(inputName, show) {
                const el = form.querySelector(`[name="${inputName}"]`);
                if (!el) return;
                if (show) el.classList.add('is-invalid'); else el.classList.remove('is-invalid');
            }

            function validateClientSide(data) {
                // data: plain object from form
                // returns null if ok or error message map {field: message}
                const errors = {};

                // nome required and length
                if (!data.nome || !String(data.nome).trim()) errors.nome = 'nome obrigatorio';
                else if (String(data.nome).length > 200) errors.nome = 'nome muito longo';

                // telefone: normalize and check 10 or 11 digits when provided
                if (data.telefone) {
                    const t = String(data.telefone).replace(/\D/g, '');
                    if (t !== '' && t.length !== 10 && t.length !== 11) errors.telefone = 'telefone invalido';
                    else data.telefone = t; // normalize for sending
                }

                // cep: normalize and check 8 digits when provided
                if (data.cep) {
                    const c = String(data.cep).replace(/\D/g, '');
                    if (c !== '' && c.length !== 8) errors.cep = 'cep invalido';
                    else data.cep = c;
                }

                // email simple check
                if (data.email) {
                    const re = /^[^@\s]+@[^@\s]+\.[^@\s]+$/;
                    if (!re.test(String(data.email))) errors.email = 'email invalido';
                }

                return Object.keys(errors).length ? errors : null;
            }

            form.addEventListener('submit', async function (e) {
                e.preventDefault();
                clearValidation();

                const fd = new FormData(e.target);
                const donoData = Object.fromEntries(fd);

                // client-side validation
                const errors = validateClientSide(Object.assign({}, donoData));
                if (errors) {
                    // mark fields
                    Object.keys(errors).forEach(f => setInvalid(f, true));
                    // focus first invalid
                    const first = Object.keys(errors)[0];
                    const el = form.querySelector(`[name="${first}"]`);
                    if (el) el.focus();
                    return;
                }

                try {
                    if (editandoId) {
                        // atualiza
                        const r = await fetch(`${API}/api/donos/${editandoId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(donoData)
                        });
                        if (!r.ok) {
                            const j = await r.json().catch(() => ({}));
                            alert(j.erro || 'Erro ao atualizar');
                        }
                        editandoId = null;
                        document.getElementById('submit-btn').textContent = 'Salvar';
                        document.getElementById('cancel-btn').style.display = 'none';
                    } else {
                        // cria novo
                        const r = await fetch(`${API}/api/donos`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(donoData)
                        });
                        if (!r.ok) {
                            const j = await r.json().catch(() => ({}));
                            alert(j.erro || 'Erro ao criar dono');
                        }
                    }

                    e.target.reset();
                    carregarDonos();
                } catch (err) {
                    console.error('Erro ao salvar dono', err);
                    alert('Erro de rede ao salvar');
                }
            });

            carregarDonos();
        });
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/inputmask/5.0.6/inputmask.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            Inputmask("(99) 99999-9999").mask(document.querySelector('input[name="telefone"]'));
            Inputmask("99999-999").mask(document.querySelector('input[name="cep"]'));
        });
    </script>

    <footer class="bg-light text-center py-3 mt-5">
        <div class="container">
            <p class="text-muted small mb-0">Trabalho de Programação Web - Marcio Santos</p>
        </div>
    </footer>
</body>

</html>