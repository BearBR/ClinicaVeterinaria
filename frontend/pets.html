<!doctype html>
<html lang="pt-br">

<head>
    <meta charset="utf-8" />
    <title>Gerenciamento de Pets - Cl√≠nica Veterin√°ria Unimar</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>

<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-success">
        <div class="container-fluid">
            <a class="btn btn-outline-light me-2" href="/">‚Üê Voltar</a>
            <a class="navbar-brand" href="/">
                üêæ Cl√≠nica Veterin√°ria Unimar
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/donos">Donos</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/pets">Pets</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/veterinarios">Veterin√°rios</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container my-4">
        <h1 class="mb-4">Gerenciamento de Pets</h1>

        <form id="form-pet" class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-success text-white">
                <h2 class="h5 mb-0">Cadastro de Pet</h2>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Nome do Pet</label>
                        <input class="form-control" name="nome" placeholder="Nome do animal" required />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Dono</label>
                        <select class="form-select" name="dono_id" required>
                            <option value="">Selecione o dono</option>
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Esp√©cie</label>
                        <select class="form-select" name="especie" required>
                            <option value="">Selecione</option>
                            <option value="cachorro">Cachorro</option>
                            <option value="gato">Gato</option>
                            <option value="ave">Ave</option>
                            <option value="roedor">Roedor</option>
                            <option value="outro">Outro</option>
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Ra√ßa</label>
                        <input class="form-control" name="raca" placeholder="Ra√ßa do animal" />
                    </div>

                    <div class="col-md-2">
                        <label class="form-label">Idade (anos)</label>
                        <input type="number" class="form-control" name="idade" min="0" max="30" />
                        <div class="invalid-feedback">Idade inv√°lida. Informe um inteiro entre 0 e 30.</div>
                    </div>

                    <div class="col-md-2">
                        <label class="form-label">Peso (kg)</label>
                        <input type="number" class="form-control" name="peso" step="0.1" min="0" max="100" inputmode="decimal" />
                        <div class="invalid-feedback">Peso inv√°lido. Informe um n√∫mero entre 0 e 100 (use ponto ou v√≠rgula).</div>
                    </div>

                    <div class="col-12">
                        <label class="form-label">Observa√ß√µes</label>
                        <textarea class="form-control" name="observacoes" rows="2"
                            placeholder="Observa√ß√µes importantes sobre o pet"></textarea>
                    </div>

                    <div class="col-12 d-grid gap-2">
                        <button class="btn btn-success" type="submit" id="submit-btn">
                            Salvar Pet
                        </button>
                        <button class="btn btn-secondary" type="button" id="cancel-btn" style="display:none;"
                            onclick="cancelarEdicao()">
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>
        </form>

        <div class="card border-0 shadow-sm">
            <div class="card-header bg-success text-white">
                <h3 class="h5 mb-0">Pets Cadastrados</h3>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>Dono</th>
                                <th>Esp√©cie</th>
                                <th>Ra√ßa</th>
                                <th>Idade</th>
                                <th>Peso</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-pets"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <script>
            const API = 'http://127.0.0.1:5000';
            let editandoId = null;

            // auth check
            fetch('/api/me').then(r => {
                if (!r.ok) window.location.href = '/login.html';
            });

            document.addEventListener('DOMContentLoaded', function () {
                carregarDonos();
                carregarPets();

                // evita que o usu√°rio digite 'e' (expoente) no campo number
                const pesoInput = document.querySelector('input[name="peso"]');
                if (pesoInput) {
                    pesoInput.addEventListener('keydown', function (ev) {
                        if (ev.key === 'e' || ev.key === 'E' || ev.key === '+' || ev.key === '-') {
                            ev.preventDefault();
                        }
                    });

                    // ao colar, limpa o valor para aceitar apenas d√≠gitos e ponto
                    pesoInput.addEventListener('paste', function (ev) {
                        ev.preventDefault();
                        const text = (ev.clipboardData || window.clipboardData).getData('text');
                        const cleaned = text.replace(/[^0-9.,]/g, '').replace(',', '.');
                        this.value = cleaned;
                    });
                }

                // helper functions to show validation inline
                function clearValidation() {
                    document.querySelectorAll('#form-pet .is-invalid').forEach(el => el.classList.remove('is-invalid'));
                }

                function setInvalid(fieldName, show) {
                    const el = document.querySelector(`#form-pet [name="${fieldName}"]`);
                    if (!el) return;
                    if (show) el.classList.add('is-invalid'); else el.classList.remove('is-invalid');
                }
                // realtime validation for idade and peso
                const idadeEl = document.querySelector('#form-pet [name="idade"]');
                const pesoEl = document.querySelector('#form-pet [name="peso"]');

                if (idadeEl) {
                    idadeEl.addEventListener('input', () => {
                        const v = String(idadeEl.value).trim();
                        if (v === '') { setInvalid('idade', false); return; }
                        const n = Number(v);
                        if (!Number.isInteger(n) || n < 0 || n > 30) setInvalid('idade', true);
                        else setInvalid('idade', false);
                    });
                }

                if (pesoEl) {
                    pesoEl.addEventListener('input', () => {
                        const raw = String(pesoEl.value).trim();
                        if (raw === '') { setInvalid('peso', false); return; }
                        const norm = raw.replace(',', '.');
                        const num = Number(norm);
                        if (!isFinite(num) || num < 0 || num > 100) setInvalid('peso', true);
                        else setInvalid('peso', false);
                    });
                }
            });

            function carregarDonos() {
                fetch(API + '/api/donos')
                    .then(r => r.json())
                    .then(donos => {
                        let sel = document.querySelector('select[name=dono_id]');
                        let html = '<option value="">Selecione o dono</option>';
                        for (let i = 0; i < donos.length; i++) {
                            html += '<option value="' + donos[i].id + '">' + donos[i].nome + '</option>';
                        }
                        sel.innerHTML = html;
                    });
            }

            function carregarPets() {
                fetch(API + '/api/pets')
                    .then(r => r.json())
                    .then(pets => {
                        let html = '';
                        for (let i = 0; i < pets.length; i++) {
                            let p = pets[i];
                            html += `
                                <tr>
                                    <td>${p.id}</td>
                                    <td><strong>${p.nome}</strong></td>
                                    <td>${p.dono_nome || ''}</td>
                                    <td>${p.especie || ''}</td>
                                    <td>${p.raca || ''}</td>
                                    <td>${p.idade || ''}</td>
                                    <td>${p.peso ? p.peso + ' kg' : ''}</td>
                                    <td>
                                        <button class="btn btn-warning btn-sm me-1" onclick="editarPet(${p.id})">Editar</button>
                                        <button class="btn btn-danger btn-sm" onclick="deletarPet(${p.id})">Excluir</button>
                                    </td>
                                </tr>
                            `;
                        }
                        document.getElementById('tbody-pets').innerHTML = html;
                    });
            }

            window.deletarPet = function (id) {
                if (!confirm('Tem certeza que quer excluir?')) return;

                fetch(API + '/api/pets/' + id, { method: 'DELETE' })
                    .then(r => {
                        if (r.ok) {
                            alert('Pet excluido!');
                            carregarPets();
                        } else {
                            alert('Erro');
                        }
                    });
            };

            window.editarPet = function (id) {
                fetch(API + '/api/pets/' + id)
                    .then(r => r.json())
                    .then(pet => {
                        let form = document.getElementById('form-pet');
                        form.nome.value = pet.nome || '';
                        form.dono_id.value = pet.dono_id || '';
                        form.especie.value = pet.especie || '';
                        form.raca.value = pet.raca || '';
                        form.idade.value = pet.idade || '';
                        form.peso.value = pet.peso || '';
                        form.observacoes.value = pet.observacoes || '';

                        editandoId = id;
                        document.getElementById('submit-btn').textContent = 'Atualizar Pet';
                        document.getElementById('cancel-btn').style.display = 'block';
                    });
            };

            window.cancelarEdicao = function () {
                editandoId = null;
                document.getElementById('form-pet').reset();
                document.getElementById('submit-btn').textContent = 'Salvar Pet';
                document.getElementById('cancel-btn').style.display = 'none';
            };

            document.getElementById('form-pet').addEventListener('submit', function (e) {
                e.preventDefault();

                let fd = new FormData(e.target);
                let dados = Object.fromEntries(fd);

                // valida peso client-side: deve ser numero (ponto ou virgula), entre 0 e 100
                clearValidation();
                let clientError = false;
                if (dados.peso !== undefined && String(dados.peso).trim() !== '') {
                    // aceita v√≠rgula como decimal
                    const pesoNormalized = String(dados.peso).replace(',', '.');
                    const pesoNum = Number(pesoNormalized);
                    if (!isFinite(pesoNum) || pesoNum < 0 || pesoNum > 100) {
                        setInvalid('peso', true);
                        clientError = true;
                    } else {
                        // envia no formato com ponto
                        dados.peso = String(pesoNum);
                    }
                } else {
                    // remove campo vazio para n√£o sobrescrever no update
                    delete dados.peso;
                }

                // valida idade se preenchida
                if (dados.idade !== undefined && String(dados.idade).trim() !== '') {
                    const idadeNum = Number(String(dados.idade));
                    if (!Number.isInteger(idadeNum) || idadeNum < 0 || idadeNum > 30) {
                        setInvalid('idade', true);
                        clientError = true;
                    } else {
                        dados.idade = String(idadeNum);
                    }
                } else {
                    delete dados.idade;
                }

                if (clientError) {
                    // focus first invalid
                    const first = document.querySelector('#form-pet .is-invalid');
                    if (first) first.focus();
                    return;
                }

                let url = API + '/api/pets';
                let metodo = 'POST';

                if (editandoId) {
                    url = url + '/' + editandoId;
                    metodo = 'PUT';
                }

                fetch(url, {
                    method: metodo,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dados)
                })
                    .then(r => {
                        if (r.ok) {
                            alert('Salvo!');
                            editandoId = null;
                            document.getElementById('submit-btn').textContent = 'Salvar Pet';
                            document.getElementById('cancel-btn').style.display = 'none';
                            e.target.reset();
                            carregarPets();
                        }
                    });
            });
        </script>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>